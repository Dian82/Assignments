\documentclass[12pt,UTF8]{ctexart}
\usepackage{titling,setspace,caption}
\usepackage{enumerate,enumitem}
\usepackage{amsmath,amssymb,amsfonts}
\usepackage{listings}
\usepackage{comment}
\usepackage{float}
\usepackage{graphicx}
\usepackage{multicol,multirow,bigstrut}
\usepackage{fancyhdr} % 页眉
\usepackage{rotating}
\usepackage{ctex,titlesec}
\usepackage[export]{adjustbox} % 图片左对齐
\usepackage[unicode=true,%本行非常重要 支持中文目录hyperref CJKbookmarks对二级目录没用
	colorlinks,
	linkcolor=black,
	anchorcolor=black,
	citecolor=black,
	CJKbookmarks=false]{hyperref}
\usepackage{xcolor}
\usepackage{geometry}
\geometry{top=25.4mm,bottom=25.4mm,left=31.8mm,right=31.8mm}
\pagestyle{plain}%删除页眉
\CTEXsetup[format={\large\bfseries}]{section}
\renewcommand\maketitlehooka{\null\mbox{}\vfill} % 标题页
\renewcommand\maketitlehookd{\vfill\null}

\newcommand{\chuhao}{\fontsize{42.2pt}{\baselineskip}\selectfont}
\newcommand{\xiaochu}{\fontsize{36.1pt}{\baselineskip}\selectfont}
\newcommand{\yihao}{\fontsize{26.1pt}{\baselineskip}\selectfont}
\newcommand{\xiaoyi}{\fontsize{24.1pt}{\baselineskip}\selectfont}
\newcommand{\erhao}{\fontsize{22.1pt}{\baselineskip}\selectfont}
\newcommand{\xiaoer}{\fontsize{18.1pt}{\baselineskip}\selectfont}
\newcommand{\sanhao}{\fontsize{16.1pt}{\baselineskip}\selectfont}
\newcommand{\xiaosan}{\fontsize{15.1pt}{\baselineskip}\selectfont}
\newcommand{\sihao}{\fontsize{14.1pt}{\baselineskip}\selectfont}
\newcommand{\xiaosi}{\fontsize{12.1pt}{\baselineskip}\selectfont}
\newcommand{\wuhao}{\fontsize{10.5pt}{\baselineskip}\selectfont}
\newcommand{\xiaowu}{\fontsize{9.0pt}{\baselineskip}\selectfont}
\newcommand{\liuhao}{\fontsize{7.5pt}{\baselineskip}\selectfont}
\newcommand{\xiaoliu}{\fontsize{6.5pt}{\baselineskip}\selectfont}
\newcommand{\qihao}{\fontsize{5.5pt}{\baselineskip}\selectfont}
\newcommand{\bahao}{\fontsize{5.0pt}{\baselineskip}\selectfont}
\titleformat{\section}{\xiaosi\bfseries}{\chinese{section}、 }{0em}{}
\titleformat{\subsection}{\wuhao\bfseries}{\Roman{subsection}. }{0em}{} %\arabic
\titleformat{\subsubsection}{\wuhao\bfseries}{\roman{subsubsection}. }{0em}{}
% \titlespacing*{hcommandi}{hlefti}{hbefore-sepi}{hafter-sepi}[hright-sepi]
\titlespacing*{\section}{0pt}{0pt}{3pt}
\titlespacing*{\subsection}{0pt}{0pt}{0pt}
\titlespacing*{\subsubsection}{0pt}{0pt}{0pt}
\captionsetup[figure]{font=small}
\captionsetup[table]{font=small}

\setenumerate[1]{itemsep=0pt,partopsep=0pt,parsep=\parskip,topsep=5pt}
\setitemize[1]{itemsep=0pt,partopsep=0pt,parsep=\parskip,topsep=5pt}

\lstset{
	language=Verilog,
	basicstyle=\tiny\ttfamily,
	escapechar={`,\&},
	showstringspaces=false,
	numbers=left,
	numberstyle=\bahao\ttfamily,
	numbersep=9pt,
	tabsize=4,
	breaklines=true,
	showtabs=false,
	frame=leftline,
	literate={\$}{{\textcolor{blue}{\$}}}1
}
\setlength{\droptitle}{-100pt}%减少标题与页眉距离

\title{
\includegraphics[width=0.2\linewidth,left]{../../SYSU.png}~\\[1cm]
\textbf{\yihao 《计算机组成原理实验》\\\chuhao实验报告\\\quad\\\xiaoyi（实验三）}
}

\vspace{100pt}

\author{}
\date{}

\newcommand{\myuline}[1]{\begin{tabular}{c}#1\\\hline\end{tabular}}

\begin{document}

\clearpage\maketitle
\thispagestyle{empty}

\vspace{100pt}
\begin{spacing}{1.5}
\xiaoer
\begin{center}
\begin{tabular}{rc}
\makebox[6.2em][s]{\textbf{学\hspace{\fill}院\hspace{\fill}名\hspace{\fill}称}} ： & 数据科学与计算机学院\\
\cline{2-2}\makebox[6.2em][s]{\textbf{专业（班级）}} ： & 17级计科教务一班\\
\cline{2-2}\makebox[6.2em][s]{\textbf{学\hspace{\fill}生\hspace{\fill}姓\hspace{\fill}名}} ：& 陈鸿峥\\
\cline{2-2}\makebox[6.2em][s]{\textbf{学\hspace{\fill}号}} ： & 17341015\\
\cline{2-2}\makebox[6.2em][s]{\textbf{时\hspace{\fill}间}} ： & 2018 年 12 月 10 日\\
\cline{2-2}
\end{tabular}
\end{center}
\end{spacing}

\newpage
\pagestyle{fancy}
\lhead{}
\rhead{\xiaowu\color{gray}{计算机组成原理实验}}
\setcounter{page}{1}
\quad\bigskip\bigskip
\rightline{\erhao\textbf{\underline{成绩：\qquad\quad}}}
\vspace{20pt}
\leftline{\erhao\textbf{\underline{实验三：多周期CPU设计与实现}}}
\vspace{-20pt}

\begin{spacing}{1.1}
\wuhao
\section{实验目的}
\begin{enumerate}
	\item 认识和掌握多周期数据通路图的构成、原理及其设计方法
    \item 掌握多周期CPU的实现方法，代码实现方法
    \item 编写一个编译器，将MIPS汇编程序编译为二进制机器码
    \item 掌握多周期CPU的测试方法
    \item 掌握多周期CPU的实现方法
\end{enumerate}


\section{实验内容}
% 实验的具体内容与要求
\qquad设计一个多周期CPU，使其至少能实现以下指令功能操作。指令与格式如表\ref{tab:mips_format}所示：
% Table generated by Excel2LaTeX from sheet 'Instruction'
\begin{table}[H]
  \centering\liuhao
  \caption{基本MIPS指令及其格式}
    \begin{tabular}{|c|l|l|l|l|l|l|}
    \hline
          & \multicolumn{1}{c|}{指令} & \multicolumn{1}{c|}{op} & \multicolumn{1}{c|}{rs} & \multicolumn{1}{c|}{rt} & \multicolumn{1}{c|}{rd} & \multicolumn{1}{c|}{sham/func} \\
    \hline
    \multirow{3}[6]{*}{算术运算} & add rd, rs, rt & 000000 & rs(5位) & rt(5位) & rd(5位) & reserved \\
\cline{2-7}          & sub rd, rs, rt & 000001 & rs(5位) & rt(5位) & rd(5位) & reserved \\
\cline{2-7}          & addiu rt, rs, imm & 000010 & rs(5位) & rt(5位) & \multicolumn{2}{c|}{imm16} \\
    \hline
    \multirow{4}[8]{*}{逻辑运算} & and rd, rs, rt & 010000 & rs(5位) & rt(5位) & rd(5位) & reserved \\
\cline{2-7}          & andi rt, rs, imm & 010001 & rs(5位) & rt(5位) & \multicolumn{2}{c|}{imm16} \\
\cline{2-7}          & ori rt, rs, imm & 010010 & rs(5位) & rt(5位) & \multicolumn{2}{c|}{imm16} \\
\cline{2-7}          & xori rt, rs, imm & 010011 & rs(5位) & rt(5位) & \multicolumn{2}{c|}{imm16} \\
    \hline
    移位    & sll rd, rt, sa & 011000 & reserved & rt(5位) & rd(5位) & sa(5位) \\
    \hline
    \multirow{2}[4]{*}{比较} & slti rt, rs, imm & 100110 & rs(5位) & rt(5位) & \multicolumn{2}{c|}{imm16} \\
\cline{2-7}          & slt rd, rs, rt & 100111 & rs(5位) & rt(5位) & rd(5位) & \multicolumn{1}{c|}{reserved} \\
    \hline
    \multirow{2}[4]{*}{访存} & sw rt, imm(rs) & 110000 & rs(5位) & rt(5位) & \multicolumn{2}{c|}{imm16} \\
\cline{2-7}          & lw rt, imm(rs) & 110001 & rs(5位) & rt(5位) & \multicolumn{2}{c|}{imm16} \\
    \hline
    \multirow{3}[6]{*}{分支} & beq rs, rt, imm & 110100 & rs(5位) & rt(5位) & \multicolumn{2}{c|}{imm16} \\
\cline{2-7}          & bne rs, rt, imm & 110101 & rs(5位) & rt(5位) & \multicolumn{2}{c|}{imm16} \\
\cline{2-7}          & bltz rs, imm & 110110 & rs(5位) & 00000 & \multicolumn{2}{c|}{imm16} \\
    \hline
    \multirow{2}[4]{*}{跳转} & j addr & 111000 & \multicolumn{4}{c|}{addr[27:2]} \\
\cline{2-7}          & jr rs & 111001 & rs(5位) & reserved & reserved & reserved \\
    \hline
    调用子程序 & jal addr & 111010 & \multicolumn{4}{c|}{addr[27:2]} \\
    \hline
    停机    & halt  & 111111 & \multicolumn{4}{l|}{00000000000000000000000000(26位)} \\
    \hline
    \end{tabular}%
  \label{tab:mips_format}%
\end{table}%
\par 注意：reserved为预留部分，一般用0填充

\section{实验器材}
\qquad电脑一台、Xilinx Vivado软件一套、Basys3板一块

\section{实验原理}
% 说明：根据需要书写相关内容，如：CPU是怎么设计的？如何验证所设计的CPU是正确的？讲清楚这两个问题。
% 1、CPU设计的思想、方法：流程图，控制信号表的作用，如何应用？相关图（模块）的说明，及其相关实现代码说明（代码部分必须有侧重点，无需太泛！），强调关键部分，必须有文字加以说明。
% 2、如何验证你设计的CPU正确性？截波形图说明。波形图上必须包含与该条指令相关的、能说明该指令正确的信号（控制信号、结果数据和地址等），还有结果存放的寄存器及内容，或数据存储器地址及内容，或顺序执行的地址，或即将转移的地址。必须说明相关信号及其作用。对设计中要求实现的每条指令都必须这么做。
% 3、实现。如何在Basys3板上运行所设计的CPU？必须在实验报告中说明设计的思想方法，操作方法。至少应该有连续5条指令以上，在板上运行的结果，拍照，贴图，来说明。

% 1、PC和寄存器组写状态使用时钟边缘触发。
% 2、指令存储器和数据存储器存储单元宽度一律使用8位，即一个字节的存储单位。不能使用32位作为存储器存储单元宽度。
% 3、控制器部分要学会用控制信号真值表方法分析问题并写出逻辑表达式；或者用case语句方法逐个产生各指令控制信号。
% 4、必须按统一测试用的汇编程序段进行测试所设计的CPU。
% 5、必须注意，实验报告中，对每条指令必须有指令执行的波形（截图），且图上必须包含关键信号，同时还要对关键信号以文字说明，这样才能说明该指令的正确性。

% 需要说明的是以上数据通路图是根据要实现的指令功能的要求画出来的，同时，还必须确定ALU的运算功能(当然，以上指令没有完全用到提供的ALU所有功能，但至少必须能实现以上指令功能操作)。从数据通路图上可以看出控制单元部分需要产生各种控制信号，当然，也有些信号必须要传送给控制单元。从指令功能要求和数据通路图的关系得出以上表1，这样，从表1可以看出各控制信号与相应指令之间的相互关系，根据这种关系就可以得出控制信号与指令之间的关系表（留给学生完成），再根据关系表可以写出各控制信号的逻辑表达式，这样控制单元部分就可实现了。
% 指令执行的结果总是在时钟下降沿保存到寄存器和存储器中，PC的改变是在时钟上升沿进行的，这样稳定性较好。另外，值得注意的问题，设计时，用模块化的思想方法设计，关于ALU设计、存储器设计、寄存器组设计等等，也是必须认真考虑的问题。

\input{basic_concepts}
\input{datapath}
\input{basic_components}
\input{control_unit}


\section{实验步骤}
\input{compiler}
\input{simulation}
\input{implementation}

\section{结果与分析}
\input{simulation_results}
\input{implementation_results}

\section{实验心得}
% 体会和建议。（必须认真写，若过于简单，扣分！）
% (所写内容，如实验的整个过程中，所碰到的问题、所思考的问题等，以及最后如何获得解决，从中得到什么?等等，当然，还可能存在未解决的问题，或有所建议等。整个来说，就是总结一下本实验的情况，温故而知新，这个道理显而易见。)
\qquad 本次实验在单周期CPU的基础上继续搭建，重用了代码模块，只需分析清除控制信号和状态转移即可。虽然看似比较简单，具体实施时还是遇到了不少问题。
\par Verilog代码编写阶段：
\begin{enumerate}
    \item 当调整输入输出端口时，一定要记得将所有相关模块全部修改，如在控制单元中添加一个控制信号，则在CPU、CPU\_sim等模块中均需添加这个控制信号。
    \item 在模块输入参数最后常常多了一个逗号\verb','，会导致报错(\verb'ISE port connections mix')。
    \item 要判断好\verb'always @'内写的内容，是时序逻辑还是组合逻辑，不能混写，不能写多，也不能写少。
    \item 要在每个模块合适的位置对寄存器进行初始化\verb'initial'，否则在仿真中会输出\verb'XXXX'。
    \item 多位的控制信号一定要记得写位宽[x:y]，这个经常会漏，且不会报错
    \item 应在时钟下降沿才进行写入操作
\end{enumerate}
\par Vivado模拟仿真上板阶段：
\begin{enumerate}
    \item 延迟设置（如\verb'#10'）具体上板实施时是会被忽略的
    \item 要做好门闩延迟(clock-to-Q)的设置，否则模块还没初始化完就开始操作，会出现很多问题，即对应的状态对应不上，会导致跳转指令无法正常跳转。
    \item 竞争与冒险的问题，在原来设计时，状态机只保存了当前状态。由于PC的更新和状态的更新是同步进行的，而由于具体电路不同路径延时不同的问题，导致PC更新时读取到的状态还是旧的，进而PC会被延迟到下一个周期才进行更新。全程的状态都会被延后一个周期，导致结果错误。因而这里很关键的一点在于状态机要设计成存储当前状态(currState)和下一状态(nextState)，当下一状态为\verb'000'时就要考虑置PCWrite为1，并在当前状态为\verb'000'时对PC进行更新。这样既解决了设置延时的问题，又解决了竞争与冒险的问题。
\end{enumerate}
\par 总的来说，多周期CPU的设计实验让我更加熟悉了Verilog的语法，熟悉Vivado的使用，同时充分了解硬件设计与软件设计的巨大区别。硬件代码难以debug使得编写程序的效率极其低下，但这时一定不能心急，要冷静下来分析问题所在，并寻求方法解决它。同时，编写硬件程序时要拥有硬件思维，要考虑得更加周密，这些都是与编写软件程序很大的不同。


\section{期末总结}
\qquad 上了一整个学期的计算机组成原理的实验课，收获了比以往课程多更多的东西，也充分体会到了计算机硬件的乐趣与奥秘。总的来说，收获有以下几点：
\begin{enumerate}
    \item 明白指令集系统的原理，并学会用MIPS指令集编写简单的汇编程序
    \item 深刻了解CPU的工作原理，明白各指令的流向，理解并实现了各条数据通路
    \item 充分了解单周期CPU和多周期CPU的工作原理，并用Verilog具体实现了两种CPU，不仅进行了仿真，也进行了具体的上板实施
    \item 实现了简单的编译器，明白如何进行解析语义，完成汇编指令到机器二进制指令的转换
    \item 更加熟练Verilog代码的编写，掌握Vivado的使用，了解FPGA仿真综合跑实施的整个流程
    \item 学会通过观察波形在仿真阶段进行硬件程序的调试，学会通过观察数码管显示的内容在具体实施阶段进行硬件程序的调试
    \item 学会组织语言，涵盖所有要点，完成几十页的长实验报告
\end{enumerate}
\par 虽然这学期的计组实验课只让我们实现了三个项目（MIPS汇编语言程序设计、单周期CPU的设计与实现、多周期CPU的设计与实现），但是学到的东西真的非常多，下面结合我这三次项目的经历以及我个人学习计算机组成原理的感受，谈谈我自己的看法。
\par 首先，我充分感受到为什么我国至今没有开发芯片的核心技术，对于芯片设计仍处于起步阶段。这很大程度上是因为芯片设计的投入与回报的不对等性。硬件投入的人力财力都非常巨大，硬件程序不同于软件，开发周期时间长，debug的难度大。这学期的实验就充分体现了这几点。硬件开发要采用硬件思维，而不能用软件思维，要对问题充分考虑周全，要不然出现了bug会相当麻烦。尽管仿真没有出现问题，但是具体上板实施时却会出现各种各样的问题。这一方面是由于仿真工具无法全真模拟真实的硬件（特别是通路之间微小延时的差距），另一方面则是由于Vivado编译器对代码的检测非常不严格，对于可能出现的问题都选择忽略；更有甚者，连warning也不提醒，典型的例子即写少位宽的问题。尽管等号赋值右侧是3位的数据，但左侧没有声明[2:0]，这种情况下vivado没有明显的报错，直接编译通过，给debug带来了极大的挑战。
\par 其次，我也了解到为什么MIPS指令集往往只用作学校的教学用，而很少有真实的硬件采用MIPS进行搭建，这很大一部分原因在于MIPS本身的局限性。对MIPS指令具体实现时会发现有些指令并不那么自然，要添加很多不必要的部件，设计一条新的数据通路。最明显的例子就是MIPS指令集中sll指令的实现，由于指令格式的不一致（5位的sa却存在最后的11位），CPU内就要添加多余的部件，并专门针对这一条指令进行数据通路的设计。这也在计算机发展了几十年以后，UCB仍要重新开发新的指令集RISC-V，并将其开源。就是因为传统的指令集肩负了太多历史包袱，越来越多新指令的出现，使得指令集变得十分笨重，也使得硬件的实施非常麻烦。
\par 第三点则从编程语言角度说的。单周期和多周期CPU的实现，我分别用Verilog各写了1000+行代码，然后就会发现Verilog的很多问题，比如它没有现代高级语言所拥有的很多设施，如递归的支持、面向对象(OOP)、高阶函数等等，换言之Verilog对于硬件操作的抽象做得比较弱，这直接导致了硬件工程师的开发效率极其低下。举个例子，由于没有参数化(parameterize)的设施，导致我在控制单元(Control Unit, CU)中添加一个新的信号，需要在CPU中的CU实例和输出端口添加该信号，还要在顶层模块的Show和CPU\_sim中添加输出端口，弄得十分麻烦。这还仅仅是两层封装，若遇到多层模块，稍微改动一下底层的模块，上层的建筑全部都得修改，可扩展性十分的差。同样因为这种低效率，UCB才开发了一门新的硬件语言Chisel（封装在Scala语言上），并已经在他们的EECS广泛使用。正是有这门相对高级的语言，才使得他们可以实现敏捷(Agile)开发，并成功制成了Rocket和BOOM等多款CPU核，还成功流片。这种前瞻性和实践性，是国内高校尚无法达到的。
\par 不仅仅是编程语言，编译器也是同样。由于手写RTL层级的硬件描述语言效率太低，所以才要有高层次综合(High Level Synthesis, HLS)，直接将高级语言的程序直接编译为硬件描述语言的程序，但是限于现在的技术，HLS的编译效果不是特别好。至于下层的综合，尽管Vivado已经做了很大的努力去优化它，但其运行的时间依然非常长。像对我们这样一个简单实验中的CPU进行综合操作，一次都要花上$5\thicksim 10$分钟，这个开销是相当巨大的。这也反映了硬件开发反馈的效率极低，导致硬件难以设计难以debug、开发周期长。
\par 综上所述，硬件开发流程中依然有很多地方是做得不够完善的，还有极大的改进空间，值得我们继续去研究探索。最后真的非常感谢学院能够开设这门课，现在都倡导软硬件协同设计，不会硬件的计算机工程师就像是缺一条腿，只有清楚地知道CPU底层的硬件实现，才有可能写出更高质量的代码，共同促进软硬件的不断发展。

\input{appendix}

\end{spacing}

\end{document}