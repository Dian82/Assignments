\documentclass[12pt,UTF8]{ctexart}
\usepackage{titling,setspace,caption}
\usepackage{enumerate,enumitem}
\usepackage{amsmath,amssymb,amsfonts}
\usepackage{listings}
\usepackage{comment}
\usepackage{float}
\usepackage{graphicx}
\usepackage{multicol,multirow,bigstrut}
\usepackage{fancyhdr} % 页眉
\usepackage{rotating}
\usepackage{ctex,titlesec}
\usepackage[export]{adjustbox} % 图片左对齐
\usepackage[unicode=true,%本行非常重要 支持中文目录hyperref CJKbookmarks对二级目录没用
	colorlinks,
	linkcolor=black,
	anchorcolor=black,
	citecolor=black,
	CJKbookmarks=false]{hyperref}
\usepackage{xcolor}
\usepackage{geometry}
\geometry{top=25.4mm,bottom=25.4mm,left=31.8mm,right=31.8mm}
\pagestyle{plain}%删除页眉
\CTEXsetup[format={\large\bfseries}]{section}
\renewcommand\maketitlehooka{\null\mbox{}\vfill} % 标题页
\renewcommand\maketitlehookd{\vfill\null}

\newcommand{\chuhao}{\fontsize{42.2pt}{\baselineskip}\selectfont}
\newcommand{\xiaochu}{\fontsize{36.1pt}{\baselineskip}\selectfont}
\newcommand{\yihao}{\fontsize{26.1pt}{\baselineskip}\selectfont}
\newcommand{\xiaoyi}{\fontsize{24.1pt}{\baselineskip}\selectfont}
\newcommand{\erhao}{\fontsize{22.1pt}{\baselineskip}\selectfont}
\newcommand{\xiaoer}{\fontsize{18.1pt}{\baselineskip}\selectfont}
\newcommand{\sanhao}{\fontsize{16.1pt}{\baselineskip}\selectfont}
\newcommand{\xiaosan}{\fontsize{15.1pt}{\baselineskip}\selectfont}
\newcommand{\sihao}{\fontsize{14.1pt}{\baselineskip}\selectfont}
\newcommand{\xiaosi}{\fontsize{12.1pt}{\baselineskip}\selectfont}
\newcommand{\wuhao}{\fontsize{10.5pt}{\baselineskip}\selectfont}
\newcommand{\xiaowu}{\fontsize{9.0pt}{\baselineskip}\selectfont}
\newcommand{\liuhao}{\fontsize{7.5pt}{\baselineskip}\selectfont}
\newcommand{\xiaoliu}{\fontsize{6.5pt}{\baselineskip}\selectfont}
\newcommand{\qihao}{\fontsize{5.5pt}{\baselineskip}\selectfont}
\newcommand{\bahao}{\fontsize{5.0pt}{\baselineskip}\selectfont}
\titleformat{\section}{\xiaosi\bfseries}{\chinese{section}、 }{0em}{}
\titleformat{\subsection}{\wuhao\bfseries}{\Roman{subsection}. }{0em}{} %\arabic
\titleformat{\subsubsection}{\wuhao\bfseries}{\roman{subsubsection}. }{0em}{}
% \titlespacing*{hcommandi}{hlefti}{hbefore-sepi}{hafter-sepi}[hright-sepi]
\titlespacing*{\section}{0pt}{0pt}{3pt}
\titlespacing*{\subsection}{0pt}{0pt}{0pt}
\titlespacing*{\subsubsection}{0pt}{0pt}{0pt}
\captionsetup[figure]{font=small}
\captionsetup[table]{font=small}

\setenumerate[1]{itemsep=0pt,partopsep=0pt,parsep=\parskip,topsep=5pt}
\setitemize[1]{itemsep=0pt,partopsep=0pt,parsep=\parskip,topsep=5pt}

\lstset{
	language=Verilog,
	basicstyle=\tiny\ttfamily,
	escapechar={`,\&},
	showstringspaces=false,
	numbers=left,
	numberstyle=\bahao\ttfamily,
	numbersep=9pt,
	tabsize=4,
	breaklines=true,
	showtabs=false,
	frame=leftline,
	literate={\$}{{\textcolor{blue}{\$}}}1
}
\setlength{\droptitle}{-100pt}%减少标题与页眉距离

\title{
\includegraphics[width=0.2\linewidth,left]{../../SYSU.png}~\\[1cm]
\textbf{\yihao 《计算机组成原理实验》\\\chuhao实验报告\\\quad\\\xiaoyi（实验二）}
}

\vspace{100pt}

\author{}
\date{}

\newcommand{\myuline}[1]{\begin{tabular}{c}#1\\\hline\end{tabular}}

\begin{document}

\clearpage\maketitle
\thispagestyle{empty}

\vspace{100pt}
\begin{spacing}{1.5}
\xiaoer
\begin{center}
\begin{tabular}{rc}
\makebox[6.2em][s]{\textbf{学\hspace{\fill}院\hspace{\fill}名\hspace{\fill}称}} ： & 数据科学与计算机学院\\
\cline{2-2}\makebox[6.2em][s]{\textbf{专业（班级）}} ： & 17级计科教务一班\\
\cline{2-2}\makebox[6.2em][s]{\textbf{学\hspace{\fill}生\hspace{\fill}姓\hspace{\fill}名}} ：& 陈鸿峥\\
\cline{2-2}\makebox[6.2em][s]{\textbf{学\hspace{\fill}号}} ： & 17341015\\
\cline{2-2}\makebox[6.2em][s]{\textbf{时\hspace{\fill}间}} ： & 2018 年 11 月 12 日\\
\cline{2-2}
\end{tabular}
\end{center}
\end{spacing}

\newpage
\pagestyle{fancy}
\lhead{}
\rhead{\xiaowu\color{gray}{计算机组成原理实验}}
\setcounter{page}{1}
\quad\bigskip\bigskip
\rightline{\erhao\textbf{\underline{成绩：\qquad\quad}}}
\vspace{20pt}
\leftline{\erhao\textbf{\underline{实验二：单周期CPU设计与实现}}}
\vspace{-20pt}

\begin{spacing}{1.1}
\wuhao
\section{实验目的}
\begin{enumerate}
	\item 掌握单周期CPU数据通路图的构成、原理及其设计方法
	\item 掌握单周期CPU的实现方法，代码实现方法
	\item 认识和掌握指令与CPU的关系
	\item 掌握测试单周期CPU的方法
\end{enumerate}


\section{实验内容}
% 实验的具体内容与要求
\qquad设计一个单周期CPU，使其至少能实现以下指令功能操作。指令与格式如下：
% Table generated by Excel2LaTeX from sheet 'Instruction'
\begin{table}[htbp]
  \centering\liuhao
  \caption{基本MIPS指令及其格式}
    \begin{tabular}{|c|l|l|l|l|l|l|l|}
    \hline
          & \multicolumn{1}{c|}{指令} & \multicolumn{1}{c|}{功能} & \multicolumn{1}{c|}{op} & \multicolumn{1}{c|}{rs} & \multicolumn{1}{c|}{rt} & \multicolumn{1}{c|}{rd} & \multicolumn{1}{c|}{sham/func} \\
    \hline
    \multirow{3}[6]{*}{算术运算} & add rd, rs, rt & \verb'rd' $\gets$ \verb'rs + rt' & 000000 & rs(5位) & rt(5位) & rd(5位) & reserved \\
\cline{2-8}          & sub rd, rs, rt & \verb'rd' $\gets$ \verb'rs - rt' & 000001 & rs(5位) & rt(5位) & rd(5位) & reserved \\
\cline{2-8}          & addiu rt, rs, imm & \verb'rt' $\gets$ \verb'rs + SignExt(imm)' & 000010 & rs(5位) & rt(5位) & \multicolumn{2}{c|}{imm16} \\
    \hline
    \multirow{4}[8]{*}{逻辑运算} & andi rt, rs, imm & \verb'rt' $\gets$ \verb'rs & ZeroExt(imm)' & 010000 & rs(5位) & rt(5位) & \multicolumn{2}{c|}{imm16} \\
\cline{2-8}          & and rd, rs, rt & \verb'rd' $\gets$ \verb'rs & rt' & 010001 & rs(5位) & rt(5位) & rd(5位) & reserved \\
\cline{2-8}          & ori rt, rs, imm & \verb'rt' $\gets$ \verb'rs | ZeroExt(imm)' & 010010 & rs(5位) & rt(5位) & \multicolumn{2}{c|}{imm16} \\
\cline{2-8}          & or rd, rs, rt & \verb'rd' $\gets$ \verb'rs | rt' & 010011 & rs(5位) & rt(5位) & rd(5位) & reserved \\
    \hline
    移位    & sll rd, rt, sa & \verb'rd' $\gets$ \verb'rt<<ZeroExt(sa)' & 011000 & reserved    & rt(5位) & rd(5位) & sa(5位) \\
    \hline
    比较    & slti rt, rs, imm & \verb'rs<SignExt(imm) ? rt=1 : rt=0' & 011100 & rs(5位) & rt(5位) & \multicolumn{2}{c|}{imm16} \\
    \hline
    \multirow{2}[4]{*}{访存} & sw rt, imm(rs) & \verb'mem[rs+SignExt(imm)]' $\gets$ \verb'rt' & 100110 & rs(5位) & rt(5位) & \multicolumn{2}{c|}{imm16} \\
\cline{2-8}          & lw rt, imm(rs) & \verb'rt' $\gets$ \verb'mem[rs+\text{SignExt}(imm)]' &100111 & rs(5位) & rt(5位) & \multicolumn{2}{c|}{imm16} \\
    \hline
    \multirow{3}[6]{*}{分支} & beq rs, rt, imm & \begin{tabular}{l}\quad\verb'rs==rt'\\\verb'? pc+4+SignExt(imm)<<2'\\\verb': pc+4'\end{tabular} & 110000 & rs(5位) & rt(5位) & \multicolumn{2}{c|}{imm16} \\
\cline{2-8}          & bne rs, rt, imm & \begin{tabular}{l}\quad\verb'rs!=rt'\\\verb'? pc+4+SignExt(imm)<<2'\\\verb': pc+4'\end{tabular} & 110001 & rs(5位) & rt(5位) & \multicolumn{2}{c|}{imm16} \\
\cline{2-8}          & bltz rs, imm & \begin{tabular}{l}\quad\verb'rs<'\$\verb'0'\\\verb'? pc+4+SignExt(imm)<<2'\\\verb': pc+4'\end{tabular} & 110010 & rs(5位) & 00000 & \multicolumn{2}{c|}{imm16} \\
    \hline
    跳转    & j addr & \verb'pc' $\gets$ $\{$\verb'(pc+4)[31:28],addr[27:2],2'$'$\verb'b00'$\}$ & 111000 & \multicolumn{4}{c|}{addr[27:2]} \\
    \hline
    停机    & halt  & halt & 111111 & \multicolumn{4}{l|}{00000000000000000000000000(26位)} \\
    \hline
    \end{tabular}%
  \label{tab:instructions}%
\end{table}%
\par 注意：reserved为预留部分，一般用0填充

\section{实验器材}
\qquad电脑一台、Xilinx Vivado软件一套、Basys3板一块

\section{实验原理}
% 说明：根据需要书写相关内容，如：CPU是怎么设计的？如何验证所设计的CPU是正确的？讲清楚这两个问题。
% 1、CPU设计的思想、方法：流程图，控制信号表的作用，如何应用？相关图（模块）的说明，及其相关实现代码说明（代码部分必须有侧重点，无需太泛！），强调关键部分，必须有文字加以说明。
% 2、如何验证你设计的CPU正确性？截波形图说明。波形图上必须包含与该条指令相关的、能说明该指令正确的信号（控制信号、结果数据和地址等），还有结果存放的寄存器及内容，或数据存储器地址及内容，或顺序执行的地址，或即将转移的地址。必须说明相关信号及其作用。对设计中要求实现的每条指令都必须这么做。
% 3、实现。如何在Basys3板上运行所设计的CPU？必须在实验报告中说明设计的思想方法，操作方法。至少应该有连续5条指令以上，在板上运行的结果，拍照，贴图，来说明。

% 1、PC和寄存器组写状态使用时钟边缘触发。
% 2、指令存储器和数据存储器存储单元宽度一律使用8位，即一个字节的存储单位。不能使用32位作为存储器存储单元宽度。
% 3、控制器部分要学会用控制信号真值表方法分析问题并写出逻辑表达式；或者用case语句方法逐个产生各指令控制信号。
% 4、必须按统一测试用的汇编程序段进行测试所设计的CPU。
% 5、必须注意，实验报告中，对每条指令必须有指令执行的波形（截图），且图上必须包含关键信号，同时还要对关键信号以文字说明，这样才能说明该指令的正确性。

% 需要说明的是以上数据通路图是根据要实现的指令功能的要求画出来的，同时，还必须确定ALU的运算功能(当然，以上指令没有完全用到提供的ALU所有功能，但至少必须能实现以上指令功能操作)。从数据通路图上可以看出控制单元部分需要产生各种控制信号，当然，也有些信号必须要传送给控制单元。从指令功能要求和数据通路图的关系得出以上表1，这样，从表1可以看出各控制信号与相应指令之间的相互关系，根据这种关系就可以得出控制信号与指令之间的关系表（留给学生完成），再根据关系表可以写出各控制信号的逻辑表达式，这样控制单元部分就可实现了。
% 指令执行的结果总是在时钟下降沿保存到寄存器和存储器中，PC的改变是在时钟上升沿进行的，这样稳定性较好。另外，值得注意的问题，设计时，用模块化的思想方法设计，关于ALU设计、存储器设计、寄存器组设计等等，也是必须认真考虑的问题。

\input{basic_concepts}
\input{datapath}
\input{basic_components}
\input{control_unit}


\section{实验步骤}
\input{simulation}
\input{implementation}

\section{结果与分析}
\subsection{仿真模拟}
\qquad 设置时钟周期为100ns，初始30ns为准备时间，然后将Reset设为1使其开始工作。仿真结果见图\ref{fig:wave_1}到图\ref{fig:wave_5}，每条指令的说明均已附在波形图之下。可以看见仿真结果与预期结果相同。
\begin{figure}[H]
\includegraphics[width=\linewidth,trim=0 260 0 0,clip]{fig/FullIns1.pdf}
\caption{波形图1}
\label{fig:wave_1}
\end{figure}
\begin{figure}[H]
\includegraphics[width=\linewidth,trim=0 50 0 0,clip]{fig/FullIns2.pdf}
\caption{波形图2}
\label{fig:wave_2}
\end{figure}
\begin{figure}[H]
\includegraphics[width=\linewidth,trim=0 130 0 0,clip]{fig/FullIns3.pdf}
\caption{波形图3}
\label{fig:wave_3}
\end{figure}
\begin{figure}[H]
\includegraphics[width=\linewidth,trim=0 120 0 0,clip]{fig/FullIns4.pdf}
\caption{波形图4}
\label{fig:wave_4}
\end{figure}
\begin{figure}[H]
\includegraphics[width=\linewidth,trim=0 100 0 0,clip]{fig/FullIns5.pdf}
\caption{波形图5}
\label{fig:wave_5}
\end{figure}

\subsection{上板}
\qquad 几条代表性指令的Basys3板结果如下，其他指令结果见具体实现。从左到右从上到下四幅图依次是：当前/下条PC、rs寄存器地址/值、rt寄存器地址/值、ALU结果输出/DB总线数据。可以看见上板结果与前面仿真分析的结果相同，成功证明了程序的正确性。
\begin{enumerate}
    \item 0x00: \verb'addiu $1, $0, 8'
    \begin{figure}[H]
    \centering
    \begin{tabular}{cc}
    \includegraphics[width=0.3\linewidth]{fig/Implementation/0x00_00.jpg}&
    \includegraphics[width=0.3\linewidth]{fig/Implementation/0x00_01.jpg}\\
    \includegraphics[width=0.3\linewidth]{fig/Implementation/0x00_10.jpg}&
    \includegraphics[width=0.3\linewidth]{fig/Implementation/0x00_11.jpg}
    \end{tabular}
    \caption{0x00结果}
    \end{figure}
    \item 0x0C: \verb'sub $5, $3, $2'
    \begin{figure}[H]
    \centering
    \begin{tabular}{cc}
    \includegraphics[width=0.3\linewidth]{fig/Implementation/0x0c_00.jpg}&
    \includegraphics[width=0.3\linewidth]{fig/Implementation/0x0c_01.jpg}\\
    \includegraphics[width=0.3\linewidth]{fig/Implementation/0x0c_10.jpg}&
    \includegraphics[width=0.3\linewidth]{fig/Implementation/0x0c_11.jpg}
    \end{tabular}
    \caption{0x0C结果}
    \end{figure}
    \item 0x14: \verb'or $8, $4, $2'
    \begin{figure}[H]
    \centering
    \begin{tabular}{cc}
    \includegraphics[width=0.3\linewidth]{fig/Implementation/0x14_00.jpg}&
    \includegraphics[width=0.3\linewidth]{fig/Implementation/0x14_01.jpg}\\
    \includegraphics[width=0.3\linewidth]{fig/Implementation/0x14_10.jpg}&
    \includegraphics[width=0.3\linewidth]{fig/Implementation/0x14_11.jpg}
    \end{tabular}
    \caption{0x14结果}
    \end{figure}
    \item 0x18: \verb'sll $8, $8, 1'
    \begin{figure}[H]
    \centering
    \begin{tabular}{cc}
    \includegraphics[width=0.3\linewidth]{fig/Implementation/0x18_00.jpg}&
    \includegraphics[width=0.3\linewidth]{fig/Implementation/0x18_01.jpg}\\
    \includegraphics[width=0.3\linewidth]{fig/Implementation/0x18_10.jpg}&
    \includegraphics[width=0.3\linewidth]{fig/Implementation/0x18_11.jpg}
    \end{tabular}
    \caption{0x18结果}
    \end{figure}
    \item 0x1C: \verb'bne $8, $1, -2'
    \begin{figure}[H]
    \centering
    \begin{tabular}{cc}
    \includegraphics[width=0.3\linewidth]{fig/Implementation/0x1c_00.jpg}&
    \includegraphics[width=0.3\linewidth]{fig/Implementation/0x1c_01.jpg}\\
    \includegraphics[width=0.3\linewidth]{fig/Implementation/0x1c_10.jpg}&
    \includegraphics[width=0.3\linewidth]{fig/Implementation/0x1c_11.jpg}
    \end{tabular}
    \caption{0x1C结果}
    \end{figure}
    \item 0x30: \verb'sw $2, 4($1)'
    \begin{figure}[H]
    \centering
    \begin{tabular}{cc}
    \includegraphics[width=0.3\linewidth]{fig/Implementation/0x30_00.jpg}&
    \includegraphics[width=0.3\linewidth]{fig/Implementation/0x30_01.jpg}\\
    \includegraphics[width=0.3\linewidth]{fig/Implementation/0x30_10.jpg}&
    \includegraphics[width=0.3\linewidth]{fig/Implementation/0x30_11.jpg}
    \end{tabular}
    \caption{0x30结果}
    \end{figure}
    \item 0x34: \verb'lw $9, 4($1)'
    \begin{figure}[H]
    \centering
    \begin{tabular}{cc}
    \includegraphics[width=0.3\linewidth]{fig/Implementation/0x34_00.jpg}&
    \includegraphics[width=0.3\linewidth]{fig/Implementation/0x34_01.jpg}\\
    \includegraphics[width=0.3\linewidth]{fig/Implementation/0x34_10.jpg}&
    \includegraphics[width=0.3\linewidth]{fig/Implementation/0x34_11.jpg}
    \end{tabular}
    \caption{0x34结果}
    \end{figure}
\end{enumerate}

\section{实验心得}
% 体会和建议。（必须认真写，若过于简单，扣分！）
% (所写内容，如实验的整个过程中，所碰到的问题、所思考的问题等，以及最后如何获得解决，从中得到什么?等等，当然，还可能存在未解决的问题，或有所建议等。整个来说，就是总结一下本实验的情况，温故而知新，这个道理显而易见。)
\qquad 本次实验可以算是从大一入学到现在做过的最大型的项目了，单单是代码文件就有十几个，虽然弄清数据通路后并不难实现，但是其中的小细节却得十分小心。
\par Verilog代码编写阶段：
\begin{enumerate}
	\item 区分非阻塞赋值\verb'<='和阻塞赋值\verb'='。简单理解，非阻塞赋值可以并行执行，而阻塞赋值只能串行执行，这里就考虑到指令之间相关性的问题了。如果指令之间不相关，则可直接并行，否则只能串行。
    \item 区分\verb'wire'和\verb'reg'类型。简单来说，\verb'wire'主要起信号间连接作用，由于它不保存状态，故它的值可以随时改变，不受时钟信号的限制，有点像Python里对象的引用赋值。而\verb'reg'顾名思义为寄存器，类似于高级程序语言的变量，可以存储数值、保存输出状态。
    \item 由于所有\verb'module'的输入输出均默认为\verb'wire'类型，写代码的时候常常会忘记加\verb'reg'导致出错。不过这个错误较为明显，在静态代码检查时即被检查出来。
    \item 在模块输入参数最后常常多了一个\verb','报错(\verb'ISE port connections mix')。
    \item \verb'always @'写时序逻辑确定好上升沿和下降沿通常没有问题，而组合逻辑常常忘记写部分输入参数，导致该输入改变了，但寄存器的值并没有改变。
    \item 要在每个模块合适的位置对寄存器进行初始化\verb'initial'，否则在仿真中会输出\verb'XXXX'。
    \item 位宽[x:y]要记清楚，对应好模块接口，否则多的位宽在跑实施时会报错。当然少了位宽没发现的话，调试起来也会很麻烦。
    \item 应在时钟下降沿才进行写入操作
    \item \verb'case'要记得写\verb'default'条件，注意检查是否所有情况都已涵盖，要不然FPGA会以奇怪的方式对未符合的情况进行匹配。
    \item vivado编译器对代码检查还是很不严格，比如在条件判断中写\verb'add >= 0 && add <= 255'，可能后者会被认为是赋值，导致结果错误。这是仿真不会出现但具体运行时会出现的问题。
    \item 32位的二进制编码不要写成\verb'8''\verb'h00000000'的形式，会被提示位数少于预定值，可能出现不可预料的错误，这个在\verb'0x3C'这条指令处卡了很久。
\end{enumerate}
% Wire和Reg不能弄混，即assign只能对Wire使用，而在initial段和always段进行赋值操作的一定是Reg;
\par Vivado模拟仿真上板阶段：
\begin{enumerate}
    \item 由于本实验采用小端存储数据，在读入时也要小心。第一次测试时因为测试指令写入文件的顺序不对，导致读入的指令全部都是反的，进而没法正常执行。通过Python重新对指令文件处理后才正常执行。
    \item 前面提及的双时钟问题，折腾了非常久的时间。
    \item 初始PC值要从$-4$开始否则第一条指令如果有写操作则无法写入
    \item 写限制文件时，漏了一个端口设置，导致到最后一步生成二进制位流才报错，又得重新跑实施综合，很费时间。
    \item 可能是电脑驱动的问题，一直报\verb'No hardware target is open'，没法将程序写入FPGA板，只能连着电脑运行程序，这个问题最终也没有解决。只好用FAT32格式化的U盘，通过Basys3的J2-USB端口写入\verb'bit'文件。
\end{enumerate}
\par 总的来说，本次实验收获非常非常多。尽管仿真没有出现问题，但是一到上板就出现了很多不可预料的问题，这些地方卡了我几天时间，非常难受。要解决硬件的问题一定要冷静下来，认真分析每条语句出现的漏洞，并且查看vivado给出的warning提示。
\par 好的方面是，我更加熟悉了Verilog的语法，熟悉Vivado的使用，同时也了解了硬件设计与软件设计的巨大区别。如FPGA要考虑指令之间是否存在依赖关系、是否可以并行等问题，而平时我们在程序设计课或数据结构课上写的算法或项目往往是不需要考虑并行的问题的，这一点在硬件设计时要考虑清楚。
当然了，更好地了解硬件也能够让我们编写出更高质量的软件代码，这两者应该相辅相成相互促进。

\input{appendix}

\end{spacing}

\end{document}